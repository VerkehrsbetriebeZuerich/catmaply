---
title: "catmaply - categorical heatmaps with plotly"
date: "`r Sys.Date()`"
author: "Yves Mauron"
output: 
  html_document:
    fig_width: 10
    fig_height: 9
    self_contained: yes
    toc: true
---
<!--
vignette: >
  %\VignetteIndexEntry{catmaply - categorical heatmaps with plotly}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}


output:
 html_document:
  fig_width: 10
  fig_height: 9
  self_contained: yes
  toc: true
---

%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Introduction to heatmaply}
-->
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include = FALSE}
library(tidyverse)
library(plotly)
library(lubridate)
```


## Introduction

A heatmap a graphical representation of data that uses a system of color-coding to represent different values. Heatmaps are used in various forms of analytics, however, this R package specifically focuses on providing an efficient way for creating interactive heatmaps for categorical data or continuous data that belongs to seperate groups/categories. 

This package is originally beeing developed for Zurich Public Transport (VBZ) to illustrate the utilization of the different routes and vehicles during different times of the day. It therefore groups utilization data (e.g. persons per m^2) into different categories (e.g. low, medium, high utilization) and plots it for certain stops over time in a heatmap.

This package is can easily be integrated into a shiny dashboard; which supports additional intactions of different kind of plots using plotly events. A mini-demo app is provided with [catmaply_shiny](https://github.com/yvesmauron/catmaply_shiny).

This work is based on the plotly.js engine. 

### Please submit feature requests

This package is still under active development. If you have features you would like to have added, please submit your suggestions (and bug-reports) at: <https://github.com/yvesmauron/catmaply/issues>

## News

You can see the most recent changes to the package in NEWS.md. 

## Installation

To install the latest ("cutting-edge") GitHub version run:

```{r}
# make sure that you have the corrent R Tools installed.
# as you might need to build some packages from source
# if do not have RTools installed, you can install it with:
# install.packages('installr'); install.Rtools() # not tested on windows
# or download it from here:
# https://cran.r-project.org/bin/windows/Rtools/
# in any case, make sure that you select the correct version, 
# otherwise the installation will fail.
# Then you'll need devtools
# if (!require('devtools'))
  # install.packages('devtools')
# Finally install the package
# devtools::install_github('yvesmauron/catmaply')
```

To get the latest release available on CRAN, perform:

```{r}
#install.packages("catmaply")
```

Thereafter you can start using the package as usual:

```{r}
library(catmaply)
```

## Basic Plotting

Get demo data provided by package.

```{r}
data("vbz")
df <- vbz[[3]]$data

knitr::kable(head(df, 10))
```

The data shows has the following structures:

- 'fahrt_seq' shows the order of the drives
- 'Haltenstellenlangname' shows the names of the stops, that need to be ordered by halt_seq
- 'Ausl_Kat' shows that category of the data point (e.g. 1 - very little people in the bus, x - bus is full)
- 'Besetzung' is the number of people per a certain m2.

So let's do a visualisation with this kind of information

```{r}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Ausl_Kat"
  )
```

How about differences in one category, e.g. one colorbar per category. Also, let's take another color palette (magma).

To show a colorbar per category, we have to but a continuous number in the fields and categorize them with a categorical column, so in our example:

- Besetzung are in the fileds
- Ausl_Kat is the categorization over these fields.

To change the color palette you can either use submit a color palette vector or a function that is able to return one.

> Note: that the color palette function needs to take n as first argument, whereas n defines the number of colors to be produced.

```{r}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Besetzung",
    categorical_colorbar = T,
    categorical_col = 'Ausl_Kat',
    color_palette = viridis::magma
  )
```

Now, lets mess around with axis formatting; lets change

- font_color to the "purplish" color in used in the logo (#6D65AB)
- change the size to 10
- change the tick_angle for the x axis to 15


```{r}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    x_tickangle = 15,
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Besetzung",
    categorical_colorbar = T,
    categorical_col = 'Ausl_Kat',
    color_palette = viridis::magma,
    font_color = '#6D65AB',
    font_size = 10
  )
```



```{r out.width = '100%', fig.height=5}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Ausl_Kat"
  )
```

How about differences in one category, e.g. one colorbar per category. Also, let's take another color palette (magma).

To show a colorbar per category, we have to but a continuous number in the fields and categorize them with a categorical column, so in our example:

- Besetzung are in the fileds
- Ausl_Kat is the categorization over these fields.

To change the color palette you can either use submit a color palette vector or a function that is able to return one.

> Note: that the color palette function needs to take n as first argument, whereas n defines the number of colors to be produced.

```{r out.width = '100%', fig.height=5}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Besetzung",
    categorical_colorbar = T,
    categorical_col = 'Ausl_Kat',
    color_palette = viridis::magma
  )
```

Now, lets mess around with axis formatting; lets change

- font_color to the "purplish" color in used in the logo (#6D65AB)
- change the size to 10
- change the tick_angle for the x axis to 15


```{r out.width = '100%', fig.height=5}
catmaply(
    df,
    x='fahrt_seq',
    x_order = 'fahrt_seq',
    x_tickangle = 15,
    y = "Haltestellenlangname",
    y_order = "halt_seq",
    z = "Besetzung",
    categorical_colorbar = T,
    categorical_col = 'Ausl_Kat',
    color_palette = viridis::magma,
    font_color = '#6D65AB',
    font_size = 10
  )
```


Hover templating:

```{r out.width = '100%', fig.height=5}
catmaply(
  df,
  x=fahrt_seq,
  x_order = fahrt_seq,
  x_tickangle = 15,
  y = Haltestellenlangname,
  y_order = halt_seq,
  z = Besetzung,
  categorical_colorbar = T,
  categorical_col = Ausl_Kat,
  color_palette = viridis::inferno,
  hover_template = paste(
    '<b>Fahrt Nr.</b>:', fahrt_seq,
    '<br><b>Haltestelle</b>:', Haltestellenlangname,
    '<br><b>Auslastung</b>:', Ausl_Kat,
    '<br><b>Besetzung</b>:', round(Besetzung, 2),
    '<extra></extra>'
  )
)
```

Define legend names:

```{r out.width = '100%', fig.height=5}
df <- df %>% 
  mutate(
    legend_col = paste("Kategorie", Ausl_Kat)
  )

catmaply(
  df,
  x=fahrt_seq,
  x_order = fahrt_seq,
  x_tickangle = 15,
  y = Haltestellenlangname,
  y_order = halt_seq,
  z = Besetzung,
  categorical_colorbar = T,
  categorical_col = Ausl_Kat,
  color_palette = viridis::inferno,
  hover_template = paste(
    '<b>Fahrt Nr.</b>:', fahrt_seq,
    '<br><b>Haltestelle</b>:', Haltestellenlangname,
    '<br><b>Auslastung</b>:', Ausl_Kat,
    '<br><b>Besetzung</b>:', round(Besetzung, 2),
    '<extra></extra>'
  ),
  legend_col = legend_col
)
```

What about hiding the legend all together.

```{r out.width = '100%', fig.height=5}
catmaply(
  df,
  x=fahrt_seq,
  x_order = fahrt_seq,
  x_tickangle = 15,
  y = Haltestellenlangname,
  y_order = halt_seq,
  z = Besetzung,
  categorical_colorbar = T,
  categorical_col = Ausl_Kat,
  color_palette = viridis::inferno,
  hover_template = paste(
    '<b>Fahrt Nr.</b>:', fahrt_seq,
    '<br><b>Haltestelle</b>:', Haltestellenlangname,
    '<br><b>Auslastung</b>:', Ausl_Kat,
    '<br><b>Besetzung</b>:', round(Besetzung, 2),
    '<extra></extra>'
  ),
  legend = F
)
```
